# Техническое задание - Telegram Bot MVP

## Структура базы данных

### Основные таблицы

#### tasks (Задачи)
- `id` - уникальный идентификатор
- `name` - название задачи
- `description` - описание задачи
- `status` - статус задачи
- `deadline` - крайний срок выполнения
- `is_deleted` - флаг удаления
- `tag` - тег задачи

#### subtasks (Подзадачи)
- `id` - уникальный идентификатор
- `name` - название подзадачи
- `deadline` - крайний срок выполнения
- `is_done` - флаг выполнения
- `is_deleted` - флаг удаления
- `task_id` - внешний ключ на задачу (каждая подзадача принадлежит одной задаче)

#### events (События)
- `id` - уникальный идентификатор
- `name` - название события
- `description` - описание события
- `start_time` - время начала события
- `end_time` - время окончания события
- `is_confirmed` - флаг подтверждения
- `is_deleted` - флаг удаления
- `tag` - тег события

#### goals (Цели)
- `id` - уникальный идентификатор
- `name` - название цели
- `description` - описание цели
- `deadline` - крайний срок достижения
- `is_confirmed` - флаг подтверждения
- `is_deleted` - флаг удаления
- `tag` - тег цели

#### ideas (Идеи)
- `id` - уникальный идентификатор
- `name` - название идеи
- `description` - описание идеи
- `is_confirmed` - флаг подтверждения
- `is_deleted` - флаг удаления
- `tag` - тег идеи

#### notes (Заметки)
- `id` - уникальный идентификатор
- `name` - название заметки
- `description` - описание заметки
- `is_deleted` - флаг удаления
- `tag` - тег заметки

#### tags (Теги)
- `id` - уникальный идентификатор
- `name` - название тега

### Таблицы взаимоотношений

Между таблицами tasks, events, goals, ideas, notes могут быть отношения many-to-many:

#### task_events (Связи задач с событиями)
- `task_id` - внешний ключ на задачу
- `event_id` - внешний ключ на событие

#### task_goals (Связи задач с целями)
- `task_id` - внешний ключ на задачу
- `goal_id` - внешний ключ на цель

#### task_ideas (Связи задач с идеями)
- `task_id` - внешний ключ на задачу
- `idea_id` - внешний ключ на идею

#### task_notes (Связи задач с заметками)
- `task_id` - внешний ключ на задачу
- `note_id` - внешний ключ на заметку

#### event_goals (Связи событий с целями)
- `event_id` - внешний ключ на событие
- `goal_id` - внешний ключ на цель

#### event_ideas (Связи событий с идеями)
- `event_id` - внешний ключ на событие
- `idea_id` - внешний ключ на идею

#### event_notes (Связи событий с заметками)
- `event_id` - внешний ключ на событие
- `note_id` - внешний ключ на заметку

#### goal_ideas (Связи целей с идеями)
- `goal_id` - внешний ключ на цель
- `idea_id` - внешний ключ на идею

#### goal_notes (Связи целей с заметками)
- `goal_id` - внешний ключ на цель
- `note_id` - внешний ключ на заметку

#### idea_notes (Связи идей с заметками)
- `idea_id` - внешний ключ на идею
- `note_id` - внешний ключ на заметку

## Команды бота

### /tasks - Управление задачами

**Начальное состояние:**
- Отображается список всех текущих задач (где is_deleted = false) в виде инлайн клавиатуры
- Каждая кнопка содержит название задачи
- При нажатии на задачу открывается меню редактирования

**Меню редактирования задачи:**
- Отображается полная информация о задаче:
  - Название
  - Описание
  - Статус
  - Тег
  - Дедлайн
  - Список связанных подзадач
  - Список связанных событий
  - Список связанных целей
  - Список связанных идей
  - Список связанных заметок

**Обычная клавиатура с кнопками:**
- "Изменить статус"
- "Изменить название"
- "Изменить описание"
- "Изменить тег"
- "Изменить дедлайн"
- "Изменить подзадачи"
- "Изменить события"
- "Изменить цели"
- "Изменить идеи"
- "Изменить заметки"
- "Удалить задачу"
- "Назад"

**Функциональность кнопок:**

1. **Изменить статус/название/описание/тег/дедлайн:**
   - Запрашивается ввод нового значения
   - После ввода значение сохраняется
   - Возврат в меню редактирования задачи

2. **Изменить дедлайн:**
   - Дополнительно: удаляется сообщение из очереди планировщика
   - Создаются новые напоминания с новым дедлайном
   - Возврат в меню редактирования задачи

3. **Изменить подзадачи/события/цели/идеи/заметки:**
   - Отображается текст со всеми связанными элементами данного типа
   - Кнопки: "Добавить" и "Убрать"
   
   **При нажатии "Добавить":**
   - Показывается список всех доступных элементов данного типа в виде инлайн меню
   - Элементы, уже связанные с задачей, изначально отмечены галочками
   - Кнопка "ОК"
   - Пользователь отмечает дополнительные элементы и нажимает "ОК"
   - Новые связи создаются в соответствующих таблицах отношений
   
   **При нажатии "Убрать":**
   - Показывается список элементов, связанных с задачей, в виде инлайн меню
   - Все элементы изначально отмечены галочками
   - Кнопка "ОК"
   - Пользователь снимает галочки с элементов, которые нужно убрать
   - Нажимает "ОК"
   - Неотмеченные элементы удаляются из таблиц отношений

4. **Удалить задачу:**
   - Запрашивается подтверждение: "Вы уверены, что хотите удалить задачу?"
   - Кнопки: "Да" и "Нет"
   - При нажатии "Да": is_deleted = true
   - При нажатии "Нет": возврат в меню редактирования

### /events - Управление событиями

**Аналогично /tasks, но с полями событий:**

**Меню редактирования события:**
- Отображается полная информация о событии:
  - Название
  - Описание
  - Время начала
  - Подтверждение
  - Тег
  - Список связанных задач
  - Список связанных целей
  - Список связанных идей
  - Список связанных заметок

**Обычная клавиатура с кнопками:**
- "Изменить название"
- "Изменить описание"
- "Изменить время начала"
- "Изменить подтверждение"
- "Изменить тег"
- "Изменить задачи"
- "Изменить цели"
- "Изменить идеи"
- "Изменить заметки"
- "Удалить событие"
- "Назад"

### /goals - Управление целями

**Аналогично /tasks, но с полями целей:**

**Меню редактирования цели:**
- Отображается полная информация о цели:
  - Название
  - Описание
  - Дедлайн
  - Подтверждение
  - Тег
  - Список связанных задач
  - Список связанных событий
  - Список связанных идей
  - Список связанных заметок

**Обычная клавиатура с кнопками:**
- "Изменить название"
- "Изменить описание"
- "Изменить дедлайн"
- "Изменить подтверждение"
- "Изменить тег"
- "Изменить задачи"
- "Изменить события"
- "Изменить идеи"
- "Изменить заметки"
- "Удалить цель"
- "Назад"

### /ideas - Управление идеями

**Аналогично /tasks, но с полями идей:**

**Меню редактирования идеи:**
- Отображается полная информация об идее:
  - Название
  - Описание
  - Подтверждение
  - Тег
  - Список связанных задач
  - Список связанных событий
  - Список связанных целей
  - Список связанных заметок

**Обычная клавиатура с кнопками:**
- "Изменить название"
- "Изменить описание"
- "Изменить подтверждение"
- "Изменить тег"
- "Изменить задачи"
- "Изменить события"
- "Изменить цели"
- "Изменить заметки"
- "Удалить идею"
- "Назад"

### /notes - Управление заметками

**Аналогично /tasks, но с полями заметок:**

**Меню редактирования заметки:**
- Отображается полная информация о заметке:
  - Название
  - Описание
  - Тег
  - Список связанных задач
  - Список связанных событий
  - Список связанных целей
  - Список связанных идей

**Обычная клавиатура с кнопками:**
- "Изменить название"
- "Изменить описание"
- "Изменить тег"
- "Изменить задачи"
- "Изменить события"
- "Изменить цели"
- "Изменить идеи"
- "Удалить заметку"
- "Назад"

### /tags - Управление тегами

**Начальное состояние:**
- Отображается список всех тегов в текстовом формате
- Кнопки: "Добавить" и "Убрать"

**При нажатии "Добавить":**
- Отправляется сообщение: "Введите название нового тега"
- Пользователь вводит текст
- Новый тег сохраняется в таблице tags
- Возврат к списку тегов

**При нажатии "Убрать":**
- Отображается список всех тегов в виде инлайн клавиатуры
- Все теги изначально отмечены галочками
- Кнопка "ОК"
- Пользователь снимает галочки с тегов, которые нужно удалить
- Нажимает "ОК"
- Неотмеченные теги удаляются из таблицы tags

### /today - Информация на сегодня

**Отображается информация:**
- Все задачи с дедлайном на сегодня
- Все подзадачи с дедлайном на сегодня
- Все события с start_time на сегодня
- Все связанные с вышеперечисленными элементы (цели, идеи, заметки)
- Все текущие цели (без фильтрации по дате)

### /week - Информация на неделю

**Отображается информация:**
- Все задачи с дедлайном на текущую неделю
- Все подзадачи с дедлайном на текущую неделю
- Все события с start_time на текущую неделю
- Все связанные с вышеперечисленными элементы (цели, идеи, заметки)
- Все текущие цели (без фильтрации по дате)

### /month - Информация на месяц

**Отображается информация:**
- Все задачи с дедлайном на текущий месяц
- Все подзадачи с дедлайном на текущий месяц
- Все события с start_time на текущий месяц
- Все связанные с вышеперечисленными элементы (цели, идеи, заметки)
- Все текущие цели (без фильтрации по дате)

### /year - Информация на год

**Отображается информация:**
- Все задачи с дедлайном на текущий год
- Все подзадачи с дедлайном на текущий год
- Все события с start_time на текущий год
- Все связанные с вышеперечисленными элементы (цели, идеи, заметки)
- Все текущие цели (без фильтрации по дате)

### /add - Добавление новых элементов

**Начальное состояние:**
- Отображается инлайн клавиатура с типами элементов:
  - "Задача"
  - "Событие"
  - "Цель"
  - "Идея"
  - "Заметка"

**После выбора типа:**
- Пользователь попадает в меню создания элемента
- Аналогично меню редактирования, но с пустыми полями
- Пользователь заполняет необходимые поля и связи

## Функциональность голосовых сообщений

**Обработка голосовых сообщений:**
1. При получении голосового сообщения в любом состоянии бота:
   - Бот выходит из текущего состояния
   - Голосовое сообщение расшифровывается в текст
   - Текст отправляется в OpenAI API

2. **Контекст для OpenAI:**
   - Весь текст расшифровки
   - Все неудаленные данные из всех таблиц (where is_deleted = false)

3. **Задача для ИИ:**
   - Определить тип элемента (task, event, goal, idea, note)
   - Извлечь поля элемента из голосового сообщения
   - Вернуть JSON с результатом

4. **Формат ответа от OpenAI:**
```json
{
  "result": "SUCCESS", // или "ERROR"
  "type": "task", // или "event", "goal", "idea", "note"
  "element": {
    "name": "название",
    "description": "описание",
    "status": "статус", // только для task
    "deadline": "2024-03-15T10:00:00Z", // для task, goal, subtask
    "start_time": "2024-03-15T10:00:00Z", // только для event
    "is_confirmed": true, // для event, goal, idea
    "tag": "тег"
  }
}
```

5. **Обработка ответа:**
   - При result = "SUCCESS": элемент сохраняется в соответствующую таблицу
   - При result = "ERROR": пользователю отправляется сообщение об ошибке

## Диаграмма переходов по состояниям

```
[Главное меню] ──→ /tasks ──→ [Список задач (inline)] ──→ [Выбор задачи] ──→ [Меню редактирования задачи]
       │                                                                              │
       │                                                                              ├─→ [Изменить статус] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить название] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить описание] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить тег] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить дедлайн] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить подзадачи] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить события] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить цели] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить идеи] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить заметки] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Удалить задачу] ──→ [Подтверждение] ──→ [Да/Нет] ──→ [Назад]
       │                                                                              └─→ [Назад] ──→ [Список задач]
       │
       ├──→ /events ──→ [Список событий (inline)] ──→ [Выбор события] ──→ [Меню редактирования события]
       │                                                                              │
       │                                                                              ├─→ [Изменить название] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить описание] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить время начала] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить подтверждение] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить тег] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить задачи] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить цели] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить идеи] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить заметки] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Удалить событие] ──→ [Подтверждение] ──→ [Да/Нет] ──→ [Назад]
       │                                                                              └─→ [Назад] ──→ [Список событий]
       │
       ├──→ /goals ──→ [Список целей (inline)] ──→ [Выбор цели] ──→ [Меню редактирования цели]
       │                                                                              │
       │                                                                              ├─→ [Изменить название] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить описание] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить дедлайн] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить подтверждение] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить тег] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить задачи] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить события] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить идеи] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить заметки] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Удалить цель] ──→ [Подтверждение] ──→ [Да/Нет] ──→ [Назад]
       │                                                                              └─→ [Назад] ──→ [Список целей]
       │
       ├──→ /ideas ──→ [Список идей (inline)] ──→ [Выбор идеи] ──→ [Меню редактирования идеи]
       │                                                                              │
       │                                                                              ├─→ [Изменить название] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить описание] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить подтверждение] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить тег] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить задачи] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить события] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить цели] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить заметки] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Удалить идею] ──→ [Подтверждение] ──→ [Да/Нет] ──→ [Назад]
       │                                                                              └─→ [Назад] ──→ [Список идей]
       │
       ├──→ /notes ──→ [Список заметок (inline)] ──→ [Выбор заметки] ──→ [Меню редактирования заметки]
       │                                                                              │
       │                                                                              ├─→ [Изменить название] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить описание] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить тег] ──→ [Ввод] ──→ [Назад]
       │                                                                              ├─→ [Изменить задачи] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить события] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить цели] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Изменить идеи] ──→ [Добавить/Убрать] ──→ [Список (inline)] ──→ [Назад]
       │                                                                              ├─→ [Удалить заметку] ──→ [Подтверждение] ──→ [Да/Нет] ──→ [Назад]
       │                                                                              └─→ [Назад] ──→ [Список заметок]
       │
       ├──→ /tags ──→ [Список тегов + кнопки]
       │                │
       │                ├─→ [Добавить] ──→ [Ввод названия] ──→ [Назад к списку]
       │                └─→ [Убрать] ──→ [Список тегов (inline с галочками)] ──→ [ОК] ──→ [Назад к списку]
       │
       ├──→ /add ──→ [Выбор типа элемента (inline)] ──→ [Меню создания элемента]
       │                                                              │
       │                                                              ├─→ [Заполнение полей] ──→ [Сохранение] ──→ [Главное меню]
       │                                                              └─→ [Отмена] ──→ [Главное меню]
       │
       ├──→ /today ──→ [Отображение информации на сегодня] ──→ [Главное меню]
       ├──→ /week ──→ [Отображение информации на неделю] ──→ [Главное меню]
       ├──→ /month ──→ [Отображение информации на месяц] ──→ [Главное меню]
       └──→ /year ──→ [Отображение информации на год] ──→ [Главное меню]

[Голосовое сообщение] ──→ [Любое состояние] ──→ [Выход из состояния] ──→ [Расшифровка] ──→ [OpenAI] ──→ [Создание элемента] ──→ [Главное меню]
```

## Дополнительные требования

1. **Планировщик напоминаний:** При изменении дедлайна задачи или события должно происходить удаление старых сообщений из очереди планировщика и создание новых напоминаний.

2. **Обработка состояний:** Голосовые сообщения имеют приоритет над любыми другими состояниями бота - при получении голосового сообщения бот выходит из текущего состояния и обрабатывает голос.

3. **Фильтрация данных:** Все операции работают только с неудаленными данными (where is_deleted = false).

4. **Интеграция с OpenAI:** Для обработки голосовых сообщений используется OpenAI API с передачей полного контекста пользовательских данных.